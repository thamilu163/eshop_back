# ============================================
# E-COMMERCE BACKEND - BASE CONFIGURATION
# Spring Boot 4.0.0 + Java 21
# ============================================

# ─────────────────────────────────────────────
# APPLICATION
# ─────────────────────────────────────────────

spring.profiles.active=${SPRING_PROFILES_ACTIVE:keycloak}
spring.main.banner-mode=console

# ─────────────────────────────────────────────
# VIRTUAL THREADS (Java 21)
# ─────────────────────────────────────────────


# ─────────────────────────────────────────────
# DATABASE
# ─────────────────────────────────────────────
# datasource configured below in the DATABASE CONFIGURATION section
# ═══════════════════════════════════════════════════════════════════════════════
# APPLICATION INFO
# ═══════════════════════════════════════════════════════════════════════════════
spring.application.name=eshop
server.port=8082

# ═══════════════════════════════════════════════════════════════════════════════
# DATABASE CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════
spring.datasource.url=jdbc:postgresql://localhost:5432/eshop_db
spring.datasource.username=${DB_USERNAME:postgres}
spring.datasource.password=${DB_PASSWORD:password}
spring.datasource.driver-class-name=org.postgresql.Driver

# HikariCP Pool Settings
spring.datasource.hikari.pool-name=EshopHikariPool
spring.datasource.hikari.maximum-pool-size=20
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.idle-timeout=600000
spring.datasource.hikari.max-lifetime=1800000

# PostgreSQL Read Replicas (disabled by default)
# Enable with: app.datasource.read-replicas.enabled=true
# Moved to app.* namespace to avoid unknown-property warnings. Handled by custom config.
app.datasource.read-replicas.enabled=${READ_REPLICAS_ENABLED:false}
app.datasource.read-replicas.url=${READ_REPLICA_URL:jdbc:postgresql://localhost:5433/eshop_db}
app.datasource.read-replicas.username=${READ_REPLICA_USERNAME:postgres}
app.datasource.read-replicas.password=${READ_REPLICA_PASSWORD:password}
app.datasource.read-replicas.driver-class-name=org.postgresql.Driver

# ═══════════════════════════════════════════════════════════════════════════════
# JPA / HIBERNATE
# ═══════════════════════════════════════════════════════════════════════════════
spring.jpa.hibernate.ddl-auto=validate
spring.jpa.open-in-view=false
spring.jpa.show-sql=false
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.properties.hibernate.default_batch_fetch_size=25
spring.jpa.properties.hibernate.order_inserts=true
spring.jpa.properties.hibernate.order_updates=true
spring.jpa.properties.hibernate.jdbc.batch_size=50
spring.jpa.properties.hibernate.jdbc.batch_versioned_data=true

# ═══════════════════════════════════════════════════════════════════════════════
# FLYWAY DATABASE MIGRATIONS
# ═══════════════════════════════════════════════════════════════════════════════
spring.flyway.enabled=true
spring.flyway.locations=classpath:db/migration
spring.flyway.baseline-on-migrate=true
spring.flyway.validate-on-migrate=true
spring.flyway.out-of-order=false
spring.flyway.clean-disabled=true
# Removed explicit baseline version/description - use baseline-on-migrate if needed

# ═══════════════════════════════════════════════════════════════════════════════
# SPRINGDOC OPENAPI / SWAGGER UI
# ═══════════════════════════════════════════════════════════════════════════════
springdoc.api-docs.enabled=true
springdoc.api-docs.path=/v3/api-docs
springdoc.swagger-ui.enabled=true
springdoc.swagger-ui.path=/swagger-ui.html
springdoc.swagger-ui.operations-sorter=method
springdoc.swagger-ui.tags-sorter=alpha
springdoc.swagger-ui.try-it-out-enabled=true
springdoc.swagger-ui.filter=true
springdoc.swagger-ui.doc-expansion=none
springdoc.swagger-ui.default-models-expand-depth=-1
springdoc.swagger-ui.display-request-duration=true
springdoc.swagger-ui.persist-authorization=true

# OAuth2 Redirect URL (this is the correct property name)
springdoc.swagger-ui.oauth2-redirect-url=http://localhost:8082/swagger-ui/oauth2-redirect.html

# ═══════════════════════════════════════════════════════════════════════════════
# ACTUATOR & MONITORING
# ═══════════════════════════════════════════════════════════════════════════════
management.endpoints.web.exposure.include=health,info,metrics,prometheus,caches,env,loggers
management.endpoints.web.base-path=/actuator
management.endpoint.health.show-details=when_authorized
management.endpoint.health.probes.enabled=true
management.health.livenessstate.enabled=true
management.health.readinessstate.enabled=true
# Redis health check (graceful with resilient mode)
management.health.redis.enabled=true
# custom health timeout kept in app namespace to avoid spring-boot property validation warnings
app.redis.health.timeout=500ms
management.info.env.enabled=true
management.info.java.enabled=true
management.info.os.enabled=true

# Prometheus Metrics
management.prometheus.metrics.export.enabled=true

# ═══════════════════════════════════════════════════════════════════════════════
# DISTRIBUTED TRACING (Micrometer + Zipkin)
# ═══════════════════════════════════════════════════════════════════════════════
management.tracing.enabled=true
management.tracing.sampling.probability=1.0
management.zipkin.tracing.endpoint=http://localhost:9411/api/v2/spans

# Observation settings
management.observations.key-values.application=${spring.application.name}

# ═══════════════════════════════════════════════════════════════════════════════
# LOGGING
# ═══════════════════════════════════════════════════════════════════════════════
logging.level.root=INFO
logging.level.com.eshop.app=DEBUG
logging.level.org.springframework.security=DEBUG
logging.level.org.springframework.security.oauth2=TRACE
logging.level.org.springframework.security.web=DEBUG
logging.level.org.springframework.web=DEBUG
logging.level.org.hibernate.SQL=DEBUG
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE
logging.level.org.springframework.web.servlet.mvc.method.annotation.ExceptionHandlerExceptionResolver=DEBUG

# HIGH-005 FIX: Include correlation ID, request ID, trace ID for distributed tracing
logging.pattern.console=%d{HH:mm:ss.SSS} [%X{correlationId:-}] [%X{requestId:-}] [%X{traceId:-},%X{spanId:-}] [%X{userId:-}] %-5level [%thread] %logger{36} - %msg%n
logging.pattern.file=%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{correlationId:-}] [%X{requestId:-}] [%X{traceId:-},%X{spanId:-}] [%X{userId:-}] %-5level [%thread] %logger{50} - %msg%n
logging.pattern.correlation=[${spring.application.name:},%X{traceId:-},%X{spanId:-}]

# ═══════════════════════════════════════════════════════════════════════════════
# SECURITY - OAuth2 / Keycloak
# ═══════════════════════════════════════════════════════════════════════════════
spring.security.oauth2.resourceserver.jwt.issuer-uri=${KEYCLOAK_ISSUER_URI:http://localhost:8080/realms/eshop}
spring.security.oauth2.resourceserver.jwt.jwk-set-uri=${KEYCLOAK_JWK_URI:http://localhost:8080/realms/eshop/protocol/openid-connect/certs}

# ═══════════════════════════════════════════════════════════════════════════════
# RESILIENT REDIS CACHE CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════
# ENHANCEMENT: Redis enabled with automatic fallback to Caffeine
# Benefits:
# - Distributed caching across multiple instances (better performance)
# - Automatic failover to local cache when Redis unavailable
# - No application crashes when Redis is down
# - Aggressive timeouts (fail fast: 500ms connect, 1s command)

app.redis.enabled=true
app.redis.resilient.mode=true

# Redis Connection
spring.data.redis.host=${REDIS_HOST:localhost}
spring.data.redis.port=${REDIS_PORT:6379}
spring.data.redis.password=${REDIS_PASSWORD:}
spring.data.redis.database=0

# Aggressive timeouts for fast failover
spring.data.redis.timeout=1000ms
spring.data.redis.connect-timeout=500ms

# CRITICAL-001 FIX: Disable Redis repository scanning (we use JPA only)
spring.data.redis.repositories.enabled=false

# Optimized Lettuce connection pool
spring.data.redis.lettuce.pool.max-active=20
spring.data.redis.lettuce.pool.max-idle=10
spring.data.redis.lettuce.pool.min-idle=2
spring.data.redis.lettuce.pool.max-wait=1000ms
spring.data.redis.lettuce.shutdown-timeout=200ms

# Cache TTL settings (application-level custom property)
app.redis.cache.default-ttl=3600

# ═══════════════════════════════════════════════════════════════════════════════
# VIRTUAL THREADS (Java 21)
# ═══════════════════════════════════════════════════════════════════════════════
spring.threads.virtual.enabled=true

# ═══════════════════════════════════════════════════════════════════════════════
# FILE UPLOAD
# ═══════════════════════════════════════════════════════════════════════════════
spring.servlet.multipart.enabled=true
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=50MB

# Metrics Distribution
management.metrics.distribution.percentiles-histogram.http.server.requests=true
management.metrics.distribution.percentiles.http.server.requests=0.5,0.95,0.99
management.metrics.distribution.slo.http.server.requests=50ms,100ms,200ms,400ms,800ms,1s,2s

# ─────────────────────────────────────────────
# REQUEST/RESPONSE LOGGING
# ─────────────────────────────────────────────
app.logging.request.enabled=${REQUEST_LOGGING_ENABLED:true}
app.logging.request.include-query-string=true
app.logging.request.include-client-info=true
app.logging.request.include-headers=false
app.logging.request.include-payload=false
app.logging.request.max-payload-length=1000

# CORS - Default exposed headers (ensure placeholder exists for all profiles)
app.cors.exposed-headers=Authorization,Content-Type,X-Request-Id

# ─────────────────────────────────────────────
# AUDIT LOGGING
# ─────────────────────────────────────────────
app.audit.enabled=${AUDIT_ENABLED:true}
app.audit.log-reads=${AUDIT_LOG_READS:false}
app.audit.log-creates=true
app.audit.log-updates=true
app.audit.log-deletes=true
app.audit.async=true

# ─────────────────────────────────────────────
# SECURITY HEADERS
# ─────────────────────────────────────────────
app.security.headers.enabled=true
app.security.headers.content-security-policy=default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'
app.security.headers.x-frame-options=DENY
app.security.headers.x-content-type-options=nosniff
app.security.headers.x-xss-protection=1; mode=block
app.security.headers.strict-transport-security=max-age=31536000; includeSubDomains
app.security.headers.referrer-policy=no-referrer

# ─────────────────────────────────────────────
# INPUT VALIDATION
# ─────────────────────────────────────────────
app.validation.max-string-length=5000
app.validation.max-collection-size=100
app.validation.sanitize-html=true
app.validation.allow-html-tags=false

# ─────────────────────────────────────────────
# IMAGE UPLOAD SECURITY
# ─────────────────────────────────────────────
app.upload.max-file-size=5242880
app.upload.max-files=10
app.upload.allowed-mime-types=image/jpeg,image/png,image/webp
app.upload.allowed-extensions=jpg,jpeg,png,webp
app.upload.max-image-width=1920
app.upload.max-image-height=1080
app.upload.compress-quality=0.85
app.upload.virus-scan-enabled=${VIRUS_SCAN_ENABLED:false}

# ─────────────────────────────────────────────
# API VERSIONING
# ─────────────────────────────────────────────
app.api.version=v1
app.api.base-path=/api/${app.api.version}
app.api.deprecated-versions=

# ─────────────────────────────────────────────
# BUSINESS RULES
# ─────────────────────────────────────────────
app.business.min-product-price=0.01
app.business.max-product-price=999999.99
app.business.max-discount-percentage=99
app.business.max-order-items=100
app.business.order-expiry-minutes=30
app.business.cart-expiry-days=30

# ─────────────────────────────────────────────
# PERFORMANCE THRESHOLDS
# ─────────────────────────────────────────────
app.performance.slow-query-threshold-ms=1000
app.performance.http-timeout-ms=30000
app.performance.async-timeout-ms=60000
app.performance.max-export-rows=100000

# ─────────────────────────────────────────────
# FEATURE FLAGS
# ─────────────────────────────────────────────
app.features.analytics.enabled=true
app.features.recommendations.enabled=true
app.features.wishlist.enabled=true
app.features.reviews.enabled=true
app.features.coupons.enabled=true
app.features.affiliate.enabled=false
app.features.subscriptions.enabled=false

# ═══════════════════════════════════════════════════════════════════════════════
# PRODUCT SERVICE CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════

# Stock Management
app.product.low-stock-threshold=10
app.product.batch-size=100
app.product.max-batch-size=100

# URL Generation (CRITICAL-002 Fix)
app.product.max-friendly-url-attempts=1000

# Caching Configuration (HIGH-004 Fix)
app.product.statistics-cache-ttl=15m

# Search Configuration
app.product.search.default-page-size=20
app.product.search.max-page-size=100
app.product.search.max-search-results-total=10000
app.product.search.max-page-number=1000

# ═══════════════════════════════════════════════════════════════════════════════
# RESILIENCE4J CIRCUIT BREAKER
# ═══════════════════════════════════════════════════════════════════════════════ 

# Payment Gateway Circuit Breaker
resilience4j.circuitbreaker.instances.paymentGateway.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.paymentGateway.slow-call-rate-threshold=80
resilience4j.circuitbreaker.instances.paymentGateway.slow-call-duration-threshold=5s
resilience4j.circuitbreaker.instances.paymentGateway.wait-duration-in-open-state=60s
resilience4j.circuitbreaker.instances.paymentGateway.sliding-window-type=COUNT_BASED
resilience4j.circuitbreaker.instances.paymentGateway.sliding-window-size=10
resilience4j.circuitbreaker.instances.paymentGateway.minimum-number-of-calls=5
resilience4j.circuitbreaker.instances.paymentGateway.permitted-number-of-calls-in-half-open-state=3
resilience4j.circuitbreaker.instances.paymentGateway.automatic-transition-from-open-to-half-open-enabled=true
resilience4j.circuitbreaker.instances.paymentGateway.register-health-indicator=true
resilience4j.circuitbreaker.instances.paymentGateway.record-exceptions=java.lang.Exception
resilience4j.circuitbreaker.instances.paymentGateway.ignore-exceptions=java.lang.IllegalArgumentException

# Email Service Circuit Breaker
resilience4j.circuitbreaker.instances.emailService.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.emailService.slow-call-rate-threshold=70
resilience4j.circuitbreaker.instances.emailService.slow-call-duration-threshold=3s
resilience4j.circuitbreaker.instances.emailService.wait-duration-in-open-state=60s
resilience4j.circuitbreaker.instances.emailService.sliding-window-type=COUNT_BASED
resilience4j.circuitbreaker.instances.emailService.sliding-window-size=10
resilience4j.circuitbreaker.instances.emailService.minimum-number-of-calls=5
resilience4j.circuitbreaker.instances.emailService.permitted-number-of-calls-in-half-open-state=2
resilience4j.circuitbreaker.instances.emailService.automatic-transition-from-open-to-half-open-enabled=true
resilience4j.circuitbreaker.instances.emailService.register-health-indicator=true

# External API Circuit Breaker
resilience4j.circuitbreaker.instances.externalApi.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.externalApi.slow-call-rate-threshold=80
resilience4j.circuitbreaker.instances.externalApi.slow-call-duration-threshold=3s
resilience4j.circuitbreaker.instances.externalApi.wait-duration-in-open-state=60s
resilience4j.circuitbreaker.instances.externalApi.sliding-window-type=COUNT_BASED
resilience4j.circuitbreaker.instances.externalApi.sliding-window-size=10
resilience4j.circuitbreaker.instances.externalApi.minimum-number-of-calls=5
resilience4j.circuitbreaker.instances.externalApi.permitted-number-of-calls-in-half-open-state=3
resilience4j.circuitbreaker.instances.externalApi.automatic-transition-from-open-to-half-open-enabled=true
resilience4j.circuitbreaker.instances.externalApi.register-health-indicator=true

# Circuit Breaker Metrics
management.metrics.distribution.percentiles-histogram.resilience4j.circuitbreaker.calls=true
management.metrics.tags.application=${spring.application.name}
